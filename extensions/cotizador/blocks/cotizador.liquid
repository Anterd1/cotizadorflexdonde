{% comment %}
  Cotizador Din√°mico con API de Cat√°logos
  Restored Version
{% endcomment %}

{{ 'cotizador.css' | asset_url | stylesheet_tag }}

<div class="cotizador-block-v2" id="cotizador-{{ block.id }}" style="
  --cotizador-padding-top: {{ block.settings.padding_top }}px;
  --cotizador-padding-sides: {{ block.settings.padding_sides }}px;
  --cotizador-padding-bottom: {{ block.settings.padding_bottom }}px;
">
  <div class="cotizador-container-v2">
    
    {% if block.settings.title != blank %}
      <div class="cotizador-header">
        <h2 class="cotizador-title-main">{{ block.settings.title }}</h2>
        <p class="cotizador-subtitle">Cotiza el valor aproximado de tus art√≠culos en minutos.</p>
      </div>
    {% endif %}

    <!-- SECCI√ìN 1: CATEGOR√çAS -->
    <div class="cotizador-categories-grid" id="categories-{{ block.id }}">
      <!-- Fila 1 -->
      <div>
        <button type="button" class="category-item" data-category="metals">
          <div class="cat-img-container">
            <img src="{{ 'icon-alhajas.png' | asset_url }}" alt="Alhajas" width="96" height="91" />
          </div>
          <span class="cat-label">Alhajas</span>
        </button>

        <button type="button" class="category-item" data-category="watches">
          <div class="cat-img-container">
            <img src="{{ 'icon-relojes.png' | asset_url }}" alt="Relojes" width="96" height="91" />
          </div>
          <span class="cat-label">Relojes</span>
        </button>

        <button type="button" class="category-item" data-category="electronics">
          <div class="cat-img-container">
            <img src="{{ 'icon-otros.png' | asset_url }}" alt="Electr√≥nicos" width="96" height="91" />
          </div>
          <span class="cat-label">Electr√≥nicos</span>
        </button>
        
        <button type="button" class="category-item" data-category="celulares">
          <div class="cat-img-container">
            <img src="{{ 'icon-celulares.png' | asset_url }}" alt="Celulares" width="96" height="91" />
          </div>
          <span class="cat-label">Celulares</span>
        </button>

        <button type="button" class="category-item" data-category="laptops">
          <div class="cat-img-container">
            <img src="{{ 'icon-laptops.png' | asset_url }}" alt="Laptops" width="96" height="91" />
          </div>
          <span class="cat-label">Laptops</span>
        </button>
      </div>

      <!-- Fila 2 -->
      <div>
        <button type="button" class="category-item" data-category="tablets">
          <div class="cat-img-container">
            <img src="{{ 'icon-tablets.png' | asset_url }}" alt="Tablets" width="96" height="91" />
          </div>
          <span class="cat-label">Tablets</span>
        </button>

        <button type="button" class="category-item" data-category="smartwatch">
          <div class="cat-img-container">
            <img src="{{ 'icon-smartwatch.png' | asset_url }}" alt="Smartwatch" width="96" height="91" />
          </div>
          <span class="cat-label">Smartwatch</span>
        </button>

        <button type="button" class="category-item" data-category="consoles">
          <div class="cat-img-container">
            <img src="{{ 'icon-consolas.png' | asset_url }}" alt="Consolas" width="96" height="91" />
          </div>
          <span class="cat-label">Consolas</span>
        </button>

        <button type="button" class="category-item" data-category="auto">
          <div class="cat-img-container">
            <img src="{{ 'icon-autos-motos.png' | asset_url }}" alt="Auto" width="96" height="91" />
          </div>
          <span class="cat-label">Auto</span>
        </button>

        <button type="button" class="category-item" data-category="moto">
          <div class="cat-img-container">
            <img src="{{ 'icon-moto.png' | asset_url }}" alt="Moto" width="96" height="91" />
          </div>
          <span class="cat-label">Moto</span>
        </button>
      </div>
    </div>

    <!-- SECCI√ìN 2: NAVEGACI√ìN DE CAT√ÅLOGO -->
    <div id="catalog-nav-{{ block.id }}" class="cotizador-catalog-nav-v2" style="display: none;">
      
      <!-- Loader de transici√≥n ELIMINADO para evitar duplicidad -->
      
      <div class="catalog-layout-v2">
        <!-- Panel Izquierdo: Detalles -->
        <div class="catalog-details-panel" id="catalog-details-{{ block.id }}">
           <a href="#" class="back-link" onclick="document.getElementById('btn-reset-catalog-{{ block.id }}').click(); return false;">
            ‚Üê Volver a categor√≠as
          </a>
          
          <!-- Progress Stepper -->
          <div class="progress-stepper" id="progress-stepper-{{ block.id }}">
            <div class="progress-step"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
    </div>

          <div class="details-panel-content" id="details-content-{{ block.id }}">
            <!-- Se llena din√°micamente -->
            <div class="details-empty-state">
              Selecciona las opciones para ver el detalle de tu cotizaci√≥n
            </div>
      </div>

          <!-- Tarjeta de Ayuda -->
          <div class="help-card">
            <div class="help-card-content">
              <h4 class="help-title">¬øNo encuentras tu art√≠culo?</h4>
              <p class="help-text">Cont√°ctanos para ayuda personalizada.</p>
              <button class="help-button">Ayuda</button>
            </div>
          </div>
          
          <button id="btn-reset-catalog-{{ block.id }}" style="display:none;">Reset</button>
        </div>

        <!-- Panel Derecho: Navegaci√≥n -->
        <div class="catalog-navigation-panel">
          
          <!-- Breadcrumb -->
          <div class="breadcrumb-v2" id="breadcrumb-{{ block.id }}" style="display:none;"></div>

          <!-- Loader -->
          <div id="loading-{{ block.id }}" class="loading-v2">
            <div class="spinner-loader">
              <div class="spinner"></div>
            </div>
            <p>Cargando opciones...</p>
      </div>

          <!-- Dropdowns Container -->
          <div id="catalog-dropdowns-{{ block.id }}" class="catalog-dropdowns-container">
            <!-- Los dropdowns se generan aqu√≠ -->
        </div>

          <!-- Items Grid (Fallback) -->
          <div id="catalog-items-{{ block.id }}" class="catalog-grid-v2" style="display: none;"></div>
          
        </div>
      </div>
    </div>

    <!-- SECCI√ìN 3: RESULTADOS (Calculadora) -->
    <div class="cotizador-main-panels" id="main-panels-{{ block.id }}" style="display: none;">
      <div class="catalog-layout-v2">
        <!-- Panel izquierdo: Detalles del art√≠culo -->
        <div class="catalog-details-panel">
          <a href="#" class="back-link" id="btn-simulate-{{ block.id }}">‚Üê Volver</a>
          
          <!-- Progress Stepper -->
          <div class="progress-stepper" id="progress-stepper-results-{{ block.id }}">
            <div class="progress-step active"></div>
            <div class="progress-step active"></div>
            <div class="progress-step active"></div>
            <div class="progress-step active"></div>
            <div class="progress-step active"></div>
            <div class="progress-step active"></div>
            <div class="progress-step active"></div>
          </div>
          
          <div class="details-panel-content" id="product-details-{{ block.id }}">
            <!-- Se llenar√° din√°micamente con los detalles del art√≠culo -->
          </div>
        </div>

        <!-- Panel de pr√©stamo: Dise√±o final -->
        <div class="loan-final-container">
          
          <!-- COLUMNA IZQUIERDA: Verde con oferta -->
          <div class="loan-col-left">
            <!-- Decoraciones de fondo -->
            <div class="loan-blob-top"></div>
            <div class="loan-blob-bottom"></div>
            
            <!-- Header con Volver -->
            <a href="#" class="loan-back-btn" id="btn-simulate-loan-{{ block.id }}">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
              <span>VOLVER</span>
            </a>
            
            <div class="loan-col-left-content">
              <!-- Oferta Principal -->
              <div class="loan-offer-section">
                <div class="loan-approved-badge">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg>
                  <span>OFERTA PRE-APROBADA</span>
                </div>
                <p class="loan-receive-label">Recibe hasta:</p>
                <h1 class="loan-amount-huge"><span>$</span><span id="loan-amount-{{ block.id }}">0.00</span></h1>
              </div>
              
              <!-- Selector de Plan Toggle -->
              <div class="loan-plan-toggle-section">
                <label class="loan-toggle-label">ELIGE TU MODALIDAD</label>
                <div class="loan-toggle-container">
                  <div class="loan-toggle-bg pos-left" id="toggle-bg-{{ block.id }}"></div>
                  <button type="button" class="loan-toggle-btn active" data-plan="tradicional" id="btn-tradicional-{{ block.id }}">TRADICIONAL</button>
                  <button type="button" class="loan-toggle-btn inactive" data-plan="fijo" id="btn-fijo-{{ block.id }}">FIJO</button>
                </div>
                <p class="loan-plan-desc" id="plan-description-text-{{ block.id }}">T√∫ decides cu√°ndo liquidar el total, pagando solo intereses en cada periodo.</p>
              </div>
              
              <!-- Tarjeta de Art√≠culo -->
              <div class="loan-article-card">
                <div class="article-card-header">
                  <span class="article-badge">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
                    TU GARANT√çA
                  </span>
                </div>
                <div class="article-details" id="article-details-{{ block.id }}">
                  <!-- Se llenar√° din√°micamente -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: Blanca con calculadora -->
          <div class="loan-col-right">
            <div class="loan-right-content">
              
              <!-- Header derecha -->
              <div class="loan-right-header">
                <div>
                  <h2 class="loan-right-title">Personaliza tu pago</h2>
                  <p class="loan-right-subtitle">Ajusta los plazos a tu medida</p>
                </div>
                <div class="loan-icon-circle">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
              </div>
              
              <!-- Selector de Frecuencia -->
              <div class="loan-freq-section">
                <label class="loan-section-label">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                  FRECUENCIA
                </label>
                <div class="loan-freq-buttons" id="frequency-options-{{ block.id }}"></div>
              </div>
              
              <!-- Slider (solo plan fijo) -->
              <div class="loan-slider-section" id="slider-container-{{ block.id }}" style="display: none;">
                <div class="loan-slider-header">
                  <label class="loan-section-label-small">PLAZO</label>
                  <div class="loan-slider-display">
                    <span class="loan-slider-num" id="slider-value-badge-{{ block.id }}">0</span>
                    <span class="loan-slider-unit" id="slider-unit-{{ block.id }}">Pagos</span>
                  </div>
                </div>
                <input type="range" class="loan-range-input" id="terms-slider-{{ block.id }}" min="0" max="0" step="1" value="0">
              </div>
              
              <!-- Cards de Resultados -->
              <div class="loan-results-grid">
                <div class="loan-result-card" id="periodic-card-{{ block.id }}">
                  <div class="loan-card-bar"></div>
                  <p class="loan-result-label" id="periodic-label-{{ block.id }}">PAGO DIARIO</p>
                  <div class="loan-result-amount-row">
                    <span class="loan-currency">$</span>
                    <span class="loan-result-value" id="payment-value-{{ block.id }}">0.00</span>
                  </div>
                </div>
                
                <div class="loan-result-card" id="final-card-{{ block.id }}">
                  <div class="loan-card-bar"></div>
                  <p class="loan-result-label" id="final-label-{{ block.id }}">LIQUIDACI√ìN FINAL</p>
                  <div class="loan-result-amount-row">
                    <span class="loan-currency" id="final-currency-{{ block.id }}">$</span>
                    <span class="loan-result-value" id="last-payment-value-{{ block.id }}">0.00</span>
                  </div>
                </div>
      </div>
    </div>

            <!-- Bot√≥n CTA -->
            <button type="button" class="loan-cta-button" id="btn-continue-{{ block.id }}">
              <span>Confirmar Pr√©stamo</span>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
          </div>
          
        </div>
      </div>
    </div>

    <!-- Paso de Selecci√≥n de Sucursal y Cita -->
    <div class="cotizador-appointment-section" id="appointment-section-{{ block.id }}" style="display: none;">
      <div class="appointment-container">
        <!-- Bot√≥n de volver a pagos -->
        <a href="#" class="back-link" id="btn-back-to-loan-{{ block.id }}" style="margin-bottom: 1rem;">
          ‚Üê Volver a selecci√≥n de pagos
        </a>
        
        <h2>Selecciona tu sucursal y horario</h2>
        <p class="appointment-subtitle">Elige la sucursal m√°s cercana y el horario que mejor te convenga</p>
        
        <!-- Selector de Estado (NUEVO) -->
        <div class="form-field">
          <label for="state-select-{{ block.id }}">Estado *</label>
          <select 
            id="state-select-{{ block.id }}" 
            name="state" 
            required
            class="cotizador-select"
          >
            <option value="">Selecciona tu estado</option>
          </select>
        </div>
        
        <!-- Selector de Sucursal -->
        <div class="form-field">
          <label for="branch-select-{{ block.id }}">Sucursal *</label>
          <select 
            id="branch-select-{{ block.id }}" 
            name="branchId" 
            required
            class="cotizador-select"
            disabled
          >
            <option value="">Primero selecciona un estado</option>
          </select>
        </div>

        <!-- Selector de Fecha con opciones predefinidas -->
        <div class="form-field">
          <label for="appointment-date-{{ block.id }}">Fecha de cita *</label>
          <div id="date-options-{{ block.id }}" class="date-options-grid">
            <!-- Se llenar√°n din√°micamente las pr√≥ximas 4 fechas disponibles -->
          </div>
          <input 
            type="hidden" 
            id="appointment-date-{{ block.id }}" 
            name="appointmentDate" 
            required
          />
        </div>

        <!-- Selector de Hora con opciones horizontales -->
        <div class="form-field">
          <label for="appointment-time-{{ block.id }}">Hora de cita *</label>
          <div id="time-options-{{ block.id }}" class="time-options-grid">
            <!-- Se llenar√°n din√°micamente los horarios disponibles -->
          </div>
          <input 
            type="hidden" 
            id="appointment-time-{{ block.id }}" 
            name="appointmentTime" 
            required
          />
        </div>

        <div class="form-field">
          <button 
            type="button" 
            class="cotizador-button"
            id="btn-continue-appointment-{{ block.id }}"
          >
            Continuar
          </button>
        </div>
      </div>
    </div>

    <!-- Formulario de Contacto -->
    <div class="cotizador-form-section" id="form-section-{{ block.id }}" style="display: none;">
      <form class="cotizador-form" id="cotizador-form-{{ block.id }}">
        <input type="hidden" name="selectedProducts" id="selected-products-data-{{ block.id }}" value="">
        <input type="hidden" name="selectedLoan" id="selected-loan-data-{{ block.id }}" value="">
        
        <h3>Completa tus datos para confirmar tu pr√©stamo</h3>
        
        <div class="form-row">
          <div class="form-field">
            <label for="customer-name-{{ block.id }}">Nombre completo *</label>
            <input 
              type="text" 
              id="customer-name-{{ block.id }}" 
              name="customerName" 
              required
              class="cotizador-input"
              placeholder="Ingresa tu nombre completo"
            />
          </div>

          <div class="form-field">
            <label for="customer-email-{{ block.id }}">Email *</label>
            <input 
              type="email" 
              id="customer-email-{{ block.id }}" 
              name="customerEmail" 
              required
              class="cotizador-input"
              placeholder="tu@email.com"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label for="customer-phone-{{ block.id }}">Tel√©fono</label>
            <input 
              type="tel" 
              id="customer-phone-{{ block.id }}" 
              name="customerPhone"
              class="cotizador-input"
              placeholder="123-456-7890"
            />
          </div>

          <div class="form-field">
            <label for="customer-message-{{ block.id }}">Mensaje adicional</label>
            <textarea 
              id="customer-message-{{ block.id }}" 
              name="message"
              rows="3"
              class="cotizador-textarea"
              placeholder="Informaci√≥n adicional..."
            ></textarea>
          </div>
        </div>

        <div class="form-field">
          <button 
            type="submit" 
            class="cotizador-button"
          >
            Enviar Solicitud
          </button>
        </div>

        <div class="cotizador-message-v2" id="cotizador-message-{{ block.id }}" style="display: none;"></div>
      </form>
    </div>

    <!-- Panel de √âxito -->
    <div class="cotizador-success-panel" id="success-panel-{{ block.id }}" style="display: none;">
      <div class="success-content">
        <div class="success-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <h2 class="success-title">¬°Cotizaci√≥n Enviada Exitosamente!</h2>
        <p class="success-message">
          Tu solicitud ha sido recibida. N√∫mero de cotizaci√≥n: <strong id="success-quote-id-{{ block.id }}">PENDIENTE</strong>
        </p>
        <p class="success-submessage">Te contactaremos pronto con m√°s informaci√≥n sobre tu pr√©stamo.</p>
        <button type="button" class="success-button" id="btn-reset-{{ block.id }}">
          Nueva Cotizaci√≥n
        </button>
      </div>
    </div>

  </div>
</div>

<!-- Modal Gen√©rico -->
<div id="modal-{{ block.id }}" class="modal" style="display: none;">
  <div class="modal-content">
    <span id="modal-close-{{ block.id }}" class="close">&times;</span>
    <div id="modal-body-{{ block.id }}"></div>
  </div>
</div>

<script src="{{ 'cotizador.js' | asset_url }}" defer></script>
<script>
  (function() {
    function initCotizador() {
      console.log('üîß Intentando inicializar CotizadorApp...');
      if (typeof CotizadorApp !== 'undefined') {
        try {
          window.cotizadorApp_{{ block.id }} = new CotizadorApp('{{ block.id }}', {
            shop: '{{ shop.permanent_domain }}',
            brandImages: {
              APPLE: '{{ "brand-apple.png" | asset_url }}',
              SAMSUNG: '{{ "brand-samsung.png" | asset_url }}',
              XIAOMI: '{{ "brand-xiaomi.png" | asset_url }}',
              MOTOROLA: '{{ "brand-motorola.png" | asset_url }}',
              SONY: '{{ "brand-sony.png" | asset_url }}',
              MICROSOFT: '{{ "brand-microsoft.png" | asset_url }}',
              NINTENDO: '{{ "brand-nintendo.png" | asset_url }}',
              LOGITECH: '{{ "brand-logitech.png" | asset_url }}'
            },
            brandImagesTablet: {
              APPLE: '{{ "brand-apple-tablet.png" | asset_url }}',
              SAMSUNG: '{{ "brand-samsung-tablet.png" | asset_url }}',
              XIAOMI: '{{ "brand-xiaomi-tablet.png" | asset_url }}'
            },
            brandImagesLaptop: {
              APPLE: '{{ "brand-apple-laptop.png" | asset_url }}',
              SAMSUNG: '{{ "brand-samsung-laptop.png" | asset_url }}',
              XIAOMI: '{{ "brand-xiaomi-laptop.png" | asset_url }}'
            }
          });
          console.log('‚úÖ CotizadorApp inicializado correctamente');
        } catch (error) {
          console.error('‚ùå Error al inicializar CotizadorApp:', error);
        }
      } else {
        console.error('‚ùå CotizadorApp no est√° definido.');
        setTimeout(() => {
          if (typeof CotizadorApp !== 'undefined') {
            console.log('üîÑ Reintentando inicializaci√≥n...');
            initCotizador();
          }
        }, 500);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCotizador);
    } else {
      initCotizador();
    }
  })();
</script>

{% schema %}
{
  "name": "Cotizador Din√°mico",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "T√≠tulo",
      "default": "Mon√©tiza tus bienes"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding superior",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_sides",
      "label": "Padding lateral",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding inferior",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "px"
    }
  ]
}
{% endschema %}
