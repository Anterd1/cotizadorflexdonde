{% comment %}
  Bloque del Cotizador con Cat√°logos de API
  Permite a los clientes solicitar cotizaciones desde el storefront
{% endcomment %}

<div class="cotizador-block" id="cotizador-{{ block.id }}">
  <div class="cotizador-container">
    {% if block.settings.title != blank %}
      <h2 class="cotizador-title">{{ block.settings.title }}</h2>
    {% endif %}
    
    {% if block.settings.description != blank %}
      <p class="cotizador-description">{{ block.settings.description }}</p>
    {% endif %}

    <!-- Secci√≥n de Selecci√≥n de Productos -->
    <div class="cotizador-catalog-section" id="catalog-section-{{ block.id }}" style="margin-bottom: 2rem;">
      <h3 style="margin-bottom: 1rem; font-size: 1.2rem;">Selecciona tus Productos</h3>
      
      <!-- Botones de Categor√≠as -->
      <div class="cotizador-categories" id="categories-{{ block.id }}" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
        <button type="button" class="cotizador-category-btn" data-category="metals" style="padding: 0.75rem 1.5rem; border: 2px solid {{ block.settings.button_color }}; background: white; color: {{ block.settings.button_color }}; border-radius: {{ block.settings.button_border_radius }}px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
          üí∞ Metales
        </button>
        <button type="button" class="cotizador-category-btn" data-category="diamonds" style="padding: 0.75rem 1.5rem; border: 2px solid {{ block.settings.button_color }}; background: white; color: {{ block.settings.button_color }}; border-radius: {{ block.settings.button_border_radius }}px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
          üíé Diamantes
        </button>
        <button type="button" class="cotizador-category-btn" data-category="electronics" style="padding: 0.75rem 1.5rem; border: 2px solid {{ block.settings.button_color }}; background: white; color: {{ block.settings.button_color }}; border-radius: {{ block.settings.button_border_radius }}px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
          üì± Electr√≥nicos
        </button>
        <button type="button" class="cotizador-category-btn" data-category="vehicles" style="padding: 0.75rem 1.5rem; border: 2px solid {{ block.settings.button_color }}; background: white; color: {{ block.settings.button_color }}; border-radius: {{ block.settings.button_border_radius }}px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
          üöó Veh√≠culos
        </button>
      </div>

      <!-- √Årea de navegaci√≥n del cat√°logo -->
      <div class="cotizador-catalog-navigation" id="catalog-nav-{{ block.id }}" style="display: none; margin-bottom: 1.5rem;">
        <div class="cotizador-breadcrumb" id="breadcrumb-{{ block.id }}" style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;"></div>
        <div class="cotizador-loading" id="loading-{{ block.id }}" style="display: none; text-align: center; padding: 2rem;">
          <span style="font-size: 2rem;">‚è≥</span>
          <p>Cargando cat√°logo...</p>
        </div>
        <div class="cotizador-catalog-items" id="catalog-items-{{ block.id }}" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
      </div>

      <!-- Productos seleccionados -->
      <div class="cotizador-selected-products" id="selected-products-{{ block.id }}" style="display: none; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.5rem;">Productos Seleccionados:</h4>
        <div id="selected-list-{{ block.id }}" style="background: #f9f9f9; padding: 1rem; border-radius: {{ block.settings.border_radius }}px; border: 1px solid {{ block.settings.border_color }};"></div>
      </div>

      <!-- L√≠neas de pr√©stamo -->
      <div class="cotizador-loan-options" id="loan-options-{{ block.id }}" style="display: none; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 1rem;">Opciones de Pr√©stamo:</h4>
        <div id="loan-products-{{ block.id }}" style="display: flex; flex-direction: column; gap: 1rem;"></div>
      </div>
    </div>

    <!-- Formulario de Contacto -->
    <form class="cotizador-form" id="cotizador-form-{{ block.id }}">
      <input type="hidden" name="selectedProducts" id="selected-products-data-{{ block.id }}" value="">
      <input type="hidden" name="selectedLoan" id="selected-loan-data-{{ block.id }}" value="">
      
      <div class="cotizador-form-group">
        <label for="customer-name-{{ block.id }}">{{ block.settings.label_name | default: "Nombre completo" }} *</label>
        <input 
          type="text" 
          id="customer-name-{{ block.id }}" 
          name="customerName" 
          required
          class="cotizador-input"
          placeholder="{{ block.settings.placeholder_name | default: 'Ingresa tu nombre' }}"
        />
      </div>

      <div class="cotizador-form-group">
        <label for="customer-email-{{ block.id }}">{{ block.settings.label_email | default: "Email" }} *</label>
        <input 
          type="email" 
          id="customer-email-{{ block.id }}" 
          name="customerEmail" 
          required
          class="cotizador-input"
          placeholder="{{ block.settings.placeholder_email | default: 'tu@email.com' }}"
        />
      </div>

      <div class="cotizador-form-group">
        <label for="customer-phone-{{ block.id }}">{{ block.settings.label_phone | default: "Tel√©fono" }}</label>
        <input 
          type="tel" 
          id="customer-phone-{{ block.id }}" 
          name="customerPhone"
          class="cotizador-input"
          placeholder="{{ block.settings.placeholder_phone | default: '123-456-7890' }}"
        />
      </div>

      <div class="cotizador-form-group">
        <label for="customer-message-{{ block.id }}">{{ block.settings.label_message | default: "Mensaje adicional" }}</label>
        <textarea 
          id="customer-message-{{ block.id }}" 
          name="message"
          rows="4"
          class="cotizador-textarea"
          placeholder="{{ block.settings.placeholder_message | default: 'Informaci√≥n adicional...' }}"
        ></textarea>
      </div>

      <div class="cotizador-form-group">
        <button 
          type="submit" 
          class="cotizador-button"
          style="background-color: {{ block.settings.button_color }}; color: {{ block.settings.button_text_color }};"
        >
          {{ block.settings.button_text | default: "Enviar Solicitud" }}
        </button>
      </div>

      <div class="cotizador-message" id="cotizador-message-{{ block.id }}" style="display: none;"></div>
    </form>
  </div>
</div>

<style>
  .cotizador-block {
    padding: {{ block.settings.padding_top }}px {{ block.settings.padding_sides }}px {{ block.settings.padding_bottom }}px;
    max-width: {{ block.settings.max_width }}px;
    margin: 0 auto;
  }

  .cotizador-title {
    font-size: {{ block.settings.title_size }}px;
    margin-bottom: 1rem;
    text-align: {{ block.settings.title_align }};
    color: {{ block.settings.title_color }};
  }

  .cotizador-description {
    text-align: {{ block.settings.description_align }};
    margin-bottom: 2rem;
    color: {{ block.settings.description_color }};
  }

  .cotizador-form-group {
    margin-bottom: 1.5rem;
  }

  .cotizador-form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: {{ block.settings.label_color }};
  }

  .cotizador-input,
  .cotizador-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid {{ block.settings.border_color }};
    border-radius: {{ block.settings.border_radius }}px;
    font-size: 1rem;
    font-family: inherit;
    box-sizing: border-box;
  }

  .cotizador-input:focus,
  .cotizador-textarea:focus {
    outline: none;
    border-color: {{ block.settings.button_color }};
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
  }

  .cotizador-textarea {
    resize: vertical;
  }

  .cotizador-button {
    width: 100%;
    padding: 1rem;
    border: none;
    border-radius: {{ block.settings.button_border_radius }}px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.3s;
  }

  .cotizador-button:hover {
    opacity: 0.9;
  }

  .cotizador-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .cotizador-category-btn:hover {
    background: {{ block.settings.button_color }} !important;
    color: {{ block.settings.button_text_color }} !important;
  }

  .cotizador-category-btn.active {
    background: {{ block.settings.button_color }} !important;
    color: {{ block.settings.button_text_color }} !important;
  }

  .cotizador-catalog-item {
    padding: 1rem;
    border: 2px solid {{ block.settings.border_color }};
    border-radius: {{ block.settings.border_radius }}px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }

  .cotizador-catalog-item:hover {
    border-color: {{ block.settings.button_color }};
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .cotizador-message {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 4px;
    text-align: center;
  }

  .cotizador-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .cotizador-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .cotizador-product-tag {
    display: inline-block;
    background: {{ block.settings.button_color }};
    color: {{ block.settings.button_text_color }};
    padding: 0.5rem 1rem;
    border-radius: {{ block.settings.button_border_radius }}px;
    margin: 0.25rem;
    font-size: 0.9rem;
  }

  .cotizador-product-tag button {
    background: none;
    border: none;
    color: {{ block.settings.button_text_color }};
    margin-left: 0.5rem;
    cursor: pointer;
    font-weight: bold;
  }

  .cotizador-loan-option {
    border: 2px solid {{ block.settings.border_color }};
    border-radius: {{ block.settings.border_radius }}px;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
  }

  .cotizador-loan-option:hover {
    border-color: {{ block.settings.button_color }};
    background: #f0f0f0;
  }

  .cotizador-loan-option input[type="radio"] {
    cursor: pointer;
  }

  .cotizador-loan-option input[type="radio"]:checked {
    accent-color: {{ block.settings.button_color }};
  }

  .cotizador-loan-option:has(input[type="radio"]:checked) {
    border-color: {{ block.settings.button_color }};
    background: {{ block.settings.button_color }};
    color: {{ block.settings.button_text_color }};
  }

  @media (max-width: 768px) {
    .cotizador-block {
      padding: 1rem;
    }

    .cotizador-title {
      font-size: {{ block.settings.title_size_mobile }}px;
    }

    .cotizador-catalog-items {
      grid-template-columns: 1fr !important;
    }

    .cotizador-categories {
      flex-direction: column;
    }

    .cotizador-category-btn {
      width: 100%;
    }

    .cotizador-loan-option {
      font-size: 0.8rem !important;
      padding: 0.4rem !important;
    }
  }
</style>

<script>
(function() {
  const blockId = '{{ block.id }}';
  const formId = `cotizador-form-${blockId}`;
  const messageId = `cotizador-message-${blockId}`;
  const form = document.getElementById(formId);
  const messageDiv = document.getElementById(messageId);
  
  // API Configuration
  const API_URL = 'https://s5mhb5u787.execute-api.us-east-1.amazonaws.com/qa';
  const API_KEY = 'unQSy6sApK5bPnIZFiqMZ2NDGgTTzIb6PRpkZ7Y1';
  
  // State
  let currentCategory = null;
  let catalogPath = [];
  let selectedProducts = [];
  let currentCatalogData = null;
  let currentLoanOptions = null;
  let selectedLoan = null;

  if (!form) return;

  // Category buttons
  const categoryButtons = document.querySelectorAll(`#categories-${blockId} .cotizador-category-btn`);
  categoryButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const category = this.getAttribute('data-category');
      selectCategory(category);
    });
  });

  function selectCategory(category) {
    currentCategory = category;
    catalogPath = [];
    
    // Update active button
    categoryButtons.forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-category="${category}"]`).classList.add('active');
    
    // Show catalog navigation
    document.getElementById(`catalog-nav-${blockId}`).style.display = 'block';
    
    // Load first catalog based on category
    let catalogId;
    switch(category) {
      case 'metals':
        catalogId = 'metal_gold_catalog';
        break;
      case 'diamonds':
        catalogId = 'diamond_color_catalog';
        break;
      case 'electronics':
        catalogId = 'subcategory_miscellaneous';
        break;
      case 'vehicles':
        catalogId = 'subcategory_vehicles';
        break;
    }
    
    loadCatalog(catalogId, {});
  }

  async function loadCatalog(catalogId, params) {
    const loadingDiv = document.getElementById(`loading-${blockId}`);
    const itemsDiv = document.getElementById(`catalog-items-${blockId}`);
    
    loadingDiv.style.display = 'block';
    itemsDiv.innerHTML = '';
    
    try {
      const endpoint = catalogId.includes('vehicles') || catalogId.includes('year') || catalogId.includes('brand_vehicles') || catalogId.includes('model_vehicles') || catalogId.includes('version') 
        ? '/simulator/catalog-ext' 
        : '/simulator/catalog';
      
      const requestBody = {
        catalog_id: catalogId,
        data: {
          user_id: '',
          prospect_flag: false,
          ...params
        }
      };
      
      console.log('Cargando cat√°logo:', catalogId);
      console.log('Endpoint:', API_URL + endpoint);
      console.log('Request body:', requestBody);
      
      const response = await fetch(`${API_URL}${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': API_KEY
        },
        body: JSON.stringify(requestBody)
      });
      
      console.log('Response status:', response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('Error response:', errorText);
        throw new Error(`Error cargando cat√°logo: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('Cat√°logo recibido:', result);
      
      currentCatalogData = result.catalog;
      
      displayCatalog(result.catalog);
      updateBreadcrumb();
      
    } catch (error) {
      console.error('Error cargando cat√°logo:', error);
      itemsDiv.innerHTML = `<p style="text-align: center; color: #e74c3c;">Error cargando cat√°logo: ${error.message}<br>Por favor intenta de nuevo.</p>`;
    } finally {
      loadingDiv.style.display = 'none';
    }
  }

  function displayCatalog(catalog) {
    const itemsDiv = document.getElementById(`catalog-items-${blockId}`);
    itemsDiv.innerHTML = '';
    
    // Si no hay data o est√° vac√≠o, significa que es el final del flujo
    // (ej: feature_3_catalog puede retornar data vac√≠o)
    if (!catalog.data || catalog.data.length === 0) {
      console.log('Cat√°logo vac√≠o - calculando precio directamente');
      calculatePriceAndAdd();
      return;
    }
    
    catalog.data.forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'cotizador-catalog-item';
      itemDiv.innerHTML = `
        <strong>${item.name}</strong>
        ${item.description ? `<p style="font-size: 0.85rem; margin-top: 0.5rem; color: #666;">${item.description}</p>` : ''}
      `;
      
      itemDiv.addEventListener('click', () => selectCatalogItem(item, catalog.catalog_id));
      itemsDiv.appendChild(itemDiv);
    });
  }

  function selectCatalogItem(item, catalogId) {
    console.log('Item seleccionado:', item);
    console.log('Catalog ID:', catalogId);
    
    catalogPath.push({ ...item, catalogId });
    console.log('Path actual:', catalogPath);
    
    // Check if has child catalog
    if (item.child && item.child !== false) {
      const nextCatalogId = item.child;
      console.log('Siguiente cat√°logo:', nextCatalogId);
      const params = extractParamsFromPath();
      console.log('Par√°metros para siguiente cat√°logo:', params);
      loadCatalog(nextCatalogId, params);
    } else {
      // Final selection - calculate price and add product
      console.log('Selecci√≥n final - calculando precio');
      calculatePriceAndAdd();
    }
  }

  function extractParamsFromPath() {
    const params = {};
    
    catalogPath.forEach(item => {
      // Para electr√≥nicos - obtener ids desde child_ids
      if (item.child_ids && Array.isArray(item.child_ids)) {
        item.child_ids.forEach(child => {
          if (child.name === 'id_pledge_lakin') params.id_pledge_lakin = child.value;
          if (child.name === 'brand_id') params.brand_id = child.value;
          if (child.name === 'model_id') params.model_id = child.value;
          if (child.name === 'charat1_id') params.charat1_id = child.value;
          if (child.name === 'charat2_id') params.charat2_id = child.value;
          if (child.name === 'charat3_id') params.charat3_id = child.value;
          // Para veh√≠culos
          if (child.name === 'vehicle_type') params.vehicle_type = child.id;
          if (child.name === 'vehicle') params.vehicle = child.id;
        });
      }
      
      // Tambi√©n obtener de las propiedades directas del item
      if (item.id_pledge_Lakin) params.id_pledge_lakin = item.id_pledge_Lakin;
      if (item.id_pledge_lakin) params.id_pledge_lakin = item.id_pledge_lakin;
      if (item.brand_id) params.brand_id = item.brand_id;
      if (item.model_id) params.model_id = item.model_id;
      if (item.charat1_id) params.charat1_id = item.charat1_id;
      if (item.charat2_id) params.charat2_id = item.charat2_id;
      if (item.charat3_id) params.charat3_id = item.charat3_id;
      
      // Para veh√≠culos
      if (item.catalogId === 'year_vehicles') params.year = item.id || item.name;
      if (item.catalogId === 'brand_vehicles') params.brand = item.id;
      if (item.catalogId === 'model_vehicles') params.model = item.id;
    });
    
    console.log('Par√°metros extra√≠dos del path:', params);
    return params;
  }

  async function calculatePriceAndAdd() {
    try {
      const priceParams = buildPriceParams();
      
      console.log('Calculando precio...');
      const response = await fetch(`${API_URL}/simulator/price`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': API_KEY
        },
        body: JSON.stringify({
          data: priceParams
        })
      });
      
      if (!response.ok) {
        throw new Error('Error calculando precio');
      }
      
      const result = await response.json();
      console.log('Precio calculado:', result.price);
      
      const product = {
        name: catalogPath.map(p => p.name).join(' > '),
        category: currentCategory,
        path: catalogPath,
        price: result.price,
        priceParams: priceParams
      };
      
      selectedProducts.push(product);
      updateSelectedProducts();
      
      // Cargar l√≠neas de pr√©stamo
      await loadLoanOptions(priceParams.category_id, priceParams.pledge_id, result.price, priceParams.params);
      
      // Reset catalog
      catalogPath = [];
      document.getElementById(`catalog-nav-${blockId}`).style.display = 'none';
      categoryButtons.forEach(btn => btn.classList.remove('active'));
      
    } catch (error) {
      console.error('Error:', error);
      alert('Error calculando el precio. Por favor intenta de nuevo.');
    }
  }

  async function loadLoanOptions(categoryId, pledgeId, price, params) {
    try {
      console.log('Cargando l√≠neas de pr√©stamo...');
      
      const requestBody = {
        data: {
          category_id: categoryId,
          pledge_id: pledgeId,
          price: price
        }
      };
      
      // Para veh√≠culos, agregar params y location
      if (categoryId === 2 || categoryId === 6) {
        requestBody.data.params = params;
        requestBody.location = {
          user_id: "",
          state: "",
          delegation: "",
          colony: "",
          cp: "",
          category: categoryId === 2 ? "Autos y Motos" : "Motos",
          category_id: String(categoryId)
        };
      }
      
      console.log('Request type-loan:', requestBody);
      
      const response = await fetch(`${API_URL}/simulator/type-loan`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': API_KEY
        },
        body: JSON.stringify(requestBody)
      });
      
      if (!response.ok) {
        throw new Error('Error obteniendo l√≠neas de pr√©stamo');
      }
      
      const result = await response.json();
      console.log('L√≠neas de pr√©stamo recibidas:', result);
      
      currentLoanOptions = result;
      displayLoanOptions(result);
      
    } catch (error) {
      console.error('Error cargando l√≠neas de pr√©stamo:', error);
      // No mostrar error, las l√≠neas de pr√©stamo son opcionales
    }
  }

  function displayLoanOptions(loanData) {
    const loanDiv = document.getElementById(`loan-options-${blockId}`);
    const productsDiv = document.getElementById(`loan-products-${blockId}`);
    
    if (!loanData || !loanData.line_products || !loanData.line_products.products) {
      loanDiv.style.display = 'none';
      return;
    }
    
    loanDiv.style.display = 'block';
    productsDiv.innerHTML = '';
    
    loanData.line_products.products.forEach((product, prodIdx) => {
      const productDiv = document.createElement('div');
      productDiv.style.cssText = 'border: 2px solid {{ block.settings.border_color }}; border-radius: {{ block.settings.border_radius }}px; padding: 1rem;';
      
      let html = `<h5 style="margin-bottom: 0.5rem; font-size: 1.1rem;">${product.product}</h5>`;
      
      product.frecuencies.forEach((freq, freqIdx) => {
        html += `
          <div style="margin-top: 1rem; padding: 0.75rem; background: #f9f9f9; border-radius: 4px;">
            <strong>Frecuencia: ${freq.frecuency}</strong>
            <p style="margin: 0.5rem 0; font-size: 0.9rem;">
              Pr√©stamo: <strong>${freq.formatted_loan}</strong> (${freq.percent})
              ${freq.formatted_loan_pref ? `<br>Pr√©stamo preferente: <strong>${freq.formatted_loan_pref}</strong> (${freq.percent_pref})` : ''}
            </p>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
        `;
        
        freq.terms.forEach((term, termIdx) => {
          const loanKey = `${prodIdx}-${freqIdx}-${termIdx}`;
          const termData = JSON.stringify(term).replace(/"/g, '&quot;');
          html += `
            <label class="cotizador-loan-option">
              <input type="radio" name="loan-option" value="${loanKey}" onchange="selectLoanOption('${loanKey}', '${termData}', '${product.product}', '${freq.frecuency}')">
              <div style="margin-left: 0.25rem;">
                <strong>${term.formatted_term}</strong>
                <div style="font-size: 0.85rem; margin-top: 0.25rem;">
                  Pago: ${term.formatted_payment}
                  ${term.formatted_payment_pref ? `<br>Pago pref.: ${term.formatted_payment_pref}` : ''}
                </div>
              </div>
            </label>
          `;
        });
        
        html += `</div></div>`;
      });
      
      productDiv.innerHTML = html;
      productsDiv.appendChild(productDiv);
    });
  }

  window.selectLoanOption = function(key, termJson, product, frequency) {
    try {
      const term = JSON.parse(termJson);
      selectedLoan = {
        key: key,
        product: product,
        frequency: frequency,
        term: term
      };
      
      console.log('Opci√≥n de pr√©stamo seleccionada:', selectedLoan);
      
      const dataInput = document.getElementById(`selected-loan-data-${blockId}`);
      dataInput.value = JSON.stringify(selectedLoan);
    } catch (error) {
      console.error('Error parseando t√©rmino de pr√©stamo:', error);
    }
  };

  function buildPriceParams() {
    const firstItem = catalogPath[0];
    const catalogId = firstItem.catalogId;
    let category_id = 1;
    let pledge_id = 4;
    const params = {};
    
    // Detectar categor√≠a bas√°ndose en el catalogId del primer item
    if (catalogId === 'metal_gold_catalog' || catalogId === 'metal_silver_catalog') {
      category_id = 1;
      pledge_id = 4;
      const metal = catalogPath[catalogPath.length - 1];
      params.karat = metal.karat_id || 14;
      params.weight = 1.0; // Default
    } else if (catalogId.includes('diamond')) {
      category_id = 1;
      pledge_id = 11;
      const color = catalogPath.find(p => p.catalogId === 'diamond_color_catalog');
      const clarity = catalogPath.find(p => p.catalogId === 'diamond_clarity_catalog');
      const size = catalogPath.find(p => p.catalogId === 'diamond_size_catalog');
      params.amount = 1;
      params.clarity_id = clarity?.clarity_id || 1;
      params.colour_id = color?.colour_id || 1;
      params.karats = size?.karat || 0.1;
      params.karats_id = size?.karat_id || 1;
      params.old_cut = "0";
    } else if (catalogId === 'subcategory_miscellaneous' || currentCategory === 'electronics') {
      // Electr√≥nicos - detectar por la categor√≠a actual tambi√©n
      category_id = 5;
      
      // Obtener pledge_id de child_ids del primer item
      const pledgeFromPath = catalogPath[0]?.id_pledge_Lakin || 
                            catalogPath[0]?.id_pledge_lakin ||
                            catalogPath[0]?.child_ids?.find(c => c.name === 'id_pledge_lakin')?.value;
      pledge_id = parseInt(pledgeFromPath) || 60;
      
      const brand = catalogPath.find(p => p.brand_id);
      const model = catalogPath.find(p => p.model_id);
      const f1 = catalogPath.find(p => p.charat1_id);
      const f2 = catalogPath.find(p => p.charat2_id);
      const f3 = catalogPath.find(p => p.charat3_id);
      
      params.brand_id = brand?.brand_id || "";
      params.model_id = model?.model_id || "";
      params.feature1_id = f1?.charat1_id || "";
      params.feature2_id = f2?.charat2_id || "";
      params.feature3_id = f3?.charat3_id || "";
    } else if (catalogId === 'subcategory_vehicles' || currentCategory === 'vehicles') {
      // Veh√≠culos - detectar por la categor√≠a actual tambi√©n
      category_id = 2;
      const vehicleType = catalogPath[0]?.child_ids?.find(c => c.name === 'vehicle_type')?.id;
      pledge_id = vehicleType === "2" ? 2 : 1;
      const year = catalogPath.find(p => p.catalogId === 'year_vehicles');
      const brand = catalogPath.find(p => p.catalogId === 'brand_vehicles');
      const model = catalogPath.find(p => p.catalogId === 'model_vehicles');
      const version = catalogPath.find(p => p.catalogId === 'version_vehicles');
      params.vehicle = catalogPath[0]?.child_ids?.find(c => c.name === 'vehicle')?.id || "0";
      params.brand_id = brand?.id || "";
      params.model_id = model?.id || "";
      params.version_id = version?.id || "";
      params.year = year?.id || year?.name || "";
    }
    
    console.log('Calculando precio con par√°metros:', { category_id, pledge_id, params });
    
    return {
      category_id,
      pledge_id,
      params
    };
  }

  function updateSelectedProducts() {
    const selectedDiv = document.getElementById(`selected-products-${blockId}`);
    const listDiv = document.getElementById(`selected-list-${blockId}`);
    const dataInput = document.getElementById(`selected-products-data-${blockId}`);
    
    if (selectedProducts.length === 0) {
      selectedDiv.style.display = 'none';
      dataInput.value = '';
      return;
    }
    
    selectedDiv.style.display = 'block';
    listDiv.innerHTML = selectedProducts.map((product, index) => `
      <div class="cotizador-product-tag">
        ${product.name} - $${product.price.toFixed(2)}
        <button type="button" onclick="removeProduct(${index})">√ó</button>
      </div>
    `).join('');
    
    dataInput.value = JSON.stringify(selectedProducts);
  }

  window.removeProduct = function(index) {
    selectedProducts.splice(index, 1);
    updateSelectedProducts();
    
    // Ocultar l√≠neas de pr√©stamo cuando se eliminan productos
    // porque las opciones cambian seg√∫n los productos
    if (selectedProducts.length === 0) {
      document.getElementById(`loan-options-${blockId}`).style.display = 'none';
      selectedLoan = null;
      document.getElementById(`selected-loan-data-${blockId}`).value = '';
    }
  };

  function updateBreadcrumb() {
    const breadcrumbDiv = document.getElementById(`breadcrumb-${blockId}`);
    if (catalogPath.length === 0) {
      breadcrumbDiv.innerHTML = '';
      return;
    }
    
    breadcrumbDiv.innerHTML = `
      <button type="button" style="background: none; border: none; color: {{ block.settings.button_color }}; cursor: pointer; text-decoration: underline;" onclick="resetCatalog()">
        ‚Üê Volver al inicio
      </button>
      <br>
      <span>${catalogPath.map(p => p.name).join(' > ')}</span>
    `;
  }

  window.resetCatalog = function() {
    catalogPath = [];
    if (currentCategory) {
      selectCategory(currentCategory);
    }
  };

  // Form submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const button = form.querySelector('button[type="submit"]');
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '{{ block.settings.button_loading_text | default: "Enviando..." }}';

    const formData = new FormData(form);
    formData.append('shop', '{{ shop.permanent_domain }}');
    formData.append('source', 'storefront');

    try {
      const response = await fetch('/apps/cotizador/quote', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok && result.success) {
        messageDiv.className = 'cotizador-message success';
        messageDiv.textContent = '{{ block.settings.success_message | default: "¬°Gracias! Te contactaremos pronto." }}';
        messageDiv.style.display = 'block';
        form.reset();
        selectedProducts = [];
        selectedLoan = null;
        updateSelectedProducts();
        document.getElementById(`loan-options-${blockId}`).style.display = 'none';
      } else {
        throw new Error(result.error || 'Error al enviar la solicitud');
      }
    } catch (error) {
      messageDiv.className = 'cotizador-message error';
      messageDiv.textContent = '{{ block.settings.error_message | default: "Error: No se pudo enviar la solicitud. Por favor intenta de nuevo." }}';
      messageDiv.style.display = 'block';
    } finally {
      button.disabled = false;
      button.textContent = originalText;
    }
  });
})();
</script>

{% schema %}
{
  "name": "Cotizador con Cat√°logos",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Contenido"
    },
    {
      "type": "text",
      "id": "title",
      "label": "T√≠tulo",
      "default": "Solicita una Cotizaci√≥n"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Tama√±o del t√≠tulo (desktop)",
      "min": 16,
      "max": 48,
      "step": 2,
      "default": 32,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "title_size_mobile",
      "label": "Tama√±o del t√≠tulo (m√≥vil)",
      "min": 16,
      "max": 32,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "title_align",
      "label": "Alineaci√≥n del t√≠tulo",
      "options": [
        { "value": "left", "label": "Izquierda" },
        { "value": "center", "label": "Centro" },
        { "value": "right", "label": "Derecha" }
      ],
      "default": "center"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Color del t√≠tulo",
      "default": "#000000"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Descripci√≥n",
      "default": "Selecciona tus productos y completa el formulario para recibir una cotizaci√≥n personalizada."
    },
    {
      "type": "select",
      "id": "description_align",
      "label": "Alineaci√≥n de la descripci√≥n",
      "options": [
        { "value": "left", "label": "Izquierda" },
        { "value": "center", "label": "Centro" },
        { "value": "right", "label": "Derecha" }
      ],
      "default": "center"
    },
    {
      "type": "color",
      "id": "description_color",
      "label": "Color de la descripci√≥n",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Etiquetas del formulario"
    },
    {
      "type": "text",
      "id": "label_name",
      "label": "Etiqueta del nombre",
      "default": "Nombre completo"
    },
    {
      "type": "text",
      "id": "label_email",
      "label": "Etiqueta del email",
      "default": "Email"
    },
    {
      "type": "text",
      "id": "label_phone",
      "label": "Etiqueta del tel√©fono",
      "default": "Tel√©fono"
    },
    {
      "type": "text",
      "id": "label_message",
      "label": "Etiqueta del mensaje",
      "default": "Mensaje adicional"
    },
    {
      "type": "header",
      "content": "Placeholders"
    },
    {
      "type": "text",
      "id": "placeholder_name",
      "label": "Placeholder del nombre",
      "default": "Ingresa tu nombre"
    },
    {
      "type": "text",
      "id": "placeholder_email",
      "label": "Placeholder del email",
      "default": "tu@email.com"
    },
    {
      "type": "text",
      "id": "placeholder_phone",
      "label": "Placeholder del tel√©fono",
      "default": "123-456-7890"
    },
    {
      "type": "text",
      "id": "placeholder_message",
      "label": "Placeholder del mensaje",
      "default": "Informaci√≥n adicional..."
    },
    {
      "type": "header",
      "content": "Bot√≥n"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Texto del bot√≥n",
      "default": "Enviar Solicitud"
    },
    {
      "type": "text",
      "id": "button_loading_text",
      "label": "Texto del bot√≥n al cargar",
      "default": "Enviando..."
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Color del bot√≥n",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Color del texto del bot√≥n",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Radio del borde del bot√≥n",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 4,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Mensajes"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Mensaje de √©xito",
      "default": "¬°Gracias! Te contactaremos pronto."
    },
    {
      "type": "text",
      "id": "error_message",
      "label": "Mensaje de error",
      "default": "Error: No se pudo enviar la solicitud. Por favor intenta de nuevo."
    },
    {
      "type": "header",
      "content": "Dise√±o"
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Color de las etiquetas",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Color del borde",
      "default": "#dddddd"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Radio del borde",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 4,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Ancho m√°ximo",
      "min": 400,
      "max": 1200,
      "step": 50,
      "default": 600,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding superior",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 30,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_sides",
      "label": "Padding lateral",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding inferior",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 30,
      "unit": "px"
    }
  ]
}
{% endschema %}
